import{_ as F,t as _,v as L,x as p,L as D,M as H,N as I,y as U,d as $,r as C,O as P,P as x,Q as M}from"./entry.7df1fe37.js";function V(t){const e=[];for(const l in t){const a=t[l];if(a.type==="TRACK_VALUE"){const r=a.tracks;(r.left==="HOLD_HEAD"||r.left==="ROLL_HEAD")&&e.push({type:r.left,track:"left",beat:a.beat,value:R(t,"left",l)}),(r.down==="HOLD_HEAD"||r.down==="ROLL_HEAD")&&e.push({type:r.down,track:"down",beat:a.beat,value:R(t,"down",l)}),(r.up==="HOLD_HEAD"||r.up==="ROLL_HEAD")&&e.push({type:r.up,track:"up",beat:a.beat,value:R(t,"up",l)}),(r.right==="HOLD_HEAD"||r.right==="ROLL_HEAD")&&e.push({type:r.right,track:"right",beat:a.beat,value:R(t,"right",l)})}}return e}function R(t,e,l){let a=0,r=parseInt(l);for(;;){const i=t[r++];if(i===void 0){console.error("Found unterminated tail");break}if(i.type==="TRACK_VALUE")if(!["ROLL_TAIL_END","HOLD_TAIL_END"].includes(i.tracks[e]))a+=i.value;else break}return a}function j(t,e,l,a,r,i){l.forEach(c=>{const u=50+(c.beat*r-i*r),m=c.value*r;let n=e.hold;switch(c.type==="ROLL_HEAD"&&(n=e.roll),c.track){case"left":t.drawImage(n,50,u+50,100,m);break;case"down":t.drawImage(n,200,u+60,100,m);break;case"up":t.drawImage(n,350,u+40,100,m);break;case"right":t.drawImage(n,500,u+50,100,m);break}})}function G(t,e,l,a,r){l.filter(i=>i.type==="TRACK_VALUE").forEach(i=>{const h=50+(i.beat*a-r*a);W(t,e,i.tracks,h),q(t,e,i.tracks,h)})}function W(t,e,l,a){t.filter="invert(100%)",l.left==="MINE"&&t.drawImage(e.left,50,a,100,100),l.down==="MINE"&&t.drawImage(e.down,200,a,100,100),l.up==="MINE"&&t.drawImage(e.up,350,a,100,100),l.right==="MINE"&&t.drawImage(e.right,500,a,100,100),t.filter="none"}function q(t,e,l,a){y(l.left)&&t.drawImage(e.left,50,a,100,100),y(l.down)&&t.drawImage(e.down,200,a,100,100),y(l.up)&&t.drawImage(e.up,350,a,100,100),y(l.right)&&t.drawImage(e.right,500,a,100,100)}function y(t){return["STEP","ROLL_HEAD","HOLD_HEAD","ROLL_TAIL_END","HOLD_TAIL_END"].includes(t)}const K={props:{chart:{type:Object,required:!0},difficulty:{type:Number,required:!0}},data(){return{canvasWidth:1920,canvasHeight:1e3,canvasContext:null,animationRequest:null,audioReady:!1,playing:!1,bpm:100,currentBeat:0,nextBeat:0,chartIndex:0,lastFrameTime:0,stopUntil:0,tailMeta:[],upLast:!1,downLast:!1,leftLast:!1,rightLast:!1,upStep:!1,downStep:!1,leftStep:!1,rightStep:!1,scrollSpeed:150,marveleousRange:1,excellentRange:5,greatRange:10,goodRange:25,score:0,combo:0}},computed:{icons(){return{up:this.$refs.up,down:this.$refs.down,left:this.$refs.left,right:this.$refs.right,hold:this.$refs.hold,roll:this.$refs.roll}},notes(){return this.chart.difficulties[this.difficulty].notes.sort((t,e)=>t.beat-e.beat)},tails(){return V(this.notes)}},methods:{mainRenderLoop(t){this.animationRequest=requestAnimationFrame(e=>{const l=e-this.lastFrameTime;this.lastFrameTime=e,this.mainRenderLoop(l)}),this.clearCanvas(),this.canvasContext.scale(window.devicePixelRatio,window.devicePixelRatio),this.drawUI(t),this.playing&&(this.incrementBeat(t),this.canvasContext.globalAlpha=1,this.checkInputs(),j(this.canvasContext,this.icons,this.tails,this.tailMeta,this.scrollSpeed,this.currentBeat),G(this.canvasContext,this.icons,this.notes,this.scrollSpeed,this.currentBeat)),this.canvasContext.scale(1/window.devicePixelRatio,1/window.devicePixelRatio)},clearCanvas(){const t=this.$refs.canvas;this.canvasContext===null&&(this.canvasContext=t.getContext("2d")),this.canvasWidth=t.clientWidth*window.devicePixelRatio,this.canvasHeight=t.clientHeight*window.devicePixelRatio,this.canvasContext.clearRect(0,0,this.canvasWidth,this.canvasHeight)},drawUI(t){this.canvasContext.globalAlpha=.7,this.canvasContext.drawImage(this.icons.left,50,50,100,100),this.canvasContext.drawImage(this.icons.down,200,50,100,100),this.canvasContext.drawImage(this.icons.up,350,50,100,100),this.canvasContext.drawImage(this.icons.right,500,50,100,100)},incrementBeat(t){if(this.currentBeat>=this.nextBeat)for(;;){const e=this.notes[this.chartIndex++];if(e===void 0){console.info("End of song"),this.completeLevel();break}if(e.type==="OFFSET"){this.currentBeat=this.currentBeat+e.value,console.info("Adjusting offset");break}else if(e.type==="SET_BPM")this.bpm=e.value,console.info("Adjusting BPM");else if(e.type==="STOP")console.info("STOPing"),this.stopUntil=this.lastFrameTime+e.value*1e3;else if(e.type==="TRACK_VALUE"){this.nextBeat=this.nextBeat+e.value;break}}if(this.stopUntil<=this.lastFrameTime){const l=this.bpm/60/1e3*t;this.currentBeat=this.currentBeat+l}},checkInputs(){},completeLevel(){this.playing=!1,this.$refs.gameAudio.pause(),this.$refs.gameAudio.currentTime=0,this.bpm=100,this.currentBeat=0,this.nextBeat=0,this.chartIndex=0,this.score=0}},watch:{tails(){this.tailMeta=this.tails.map(t=>({active:!0,available:!0}))},chart(){this.completeLevel()},difficulty(){this.completeLevel()}},mounted(){this.mainRenderLoop(0)},beforeDestroy(){this.animationRequest&&cancelAnimationFrame(this.animationRequest)}},Y=""+new URL("left.c90f5fe9.svg",import.meta.url).href,Q=""+new URL("down.2d1e9473.svg",import.meta.url).href,z=""+new URL("up.3debce1e.svg",import.meta.url).href,J=""+new URL("right.d17938a6.svg",import.meta.url).href,X=""+new URL("hold.a53bb1d9.svg",import.meta.url).href,Z=""+new URL("roll.2890998c.svg",import.meta.url).href;const tt={class:"w-full h-full relative"},et=["src"],at={ref:"left",class:"hidden",src:Y,loading:"eager"},rt={ref:"down",class:"hidden",src:Q,loading:"eager"},lt={ref:"up",class:"hidden",src:z,loading:"eager"},it={ref:"right",class:"hidden",src:J,loading:"eager"},nt={ref:"hold",class:"hidden",src:X,loading:"eager"},st={ref:"roll",class:"hidden",src:Z,mloading:"eager"},ot=["width","height"],ct=["src"],ut={class:"w-full h-full relative p-10 font-extrabold text-2xl text-white"};function dt(t,e,l,a,r,i){return _(),L("div",null,[p("div",tt,[l.chart.backgroundUrl?(_(),L("img",{key:0,class:"absolute w-full h-full top-0 left-0 right-0 bottom-0 object-cover",src:l.chart.backgroundUrl},null,8,et)):D("",!0),p("img",at,null,512),p("img",rt,null,512),p("img",lt,null,512),p("img",it,null,512),p("img",nt,null,512),p("img",st,null,512),p("canvas",{class:"track-canvas",ref:"canvas",width:r.canvasWidth,height:r.canvasHeight},null,8,ot),p("audio",{ref:"gameAudio",src:l.chart.songUrl,onCanplaythrough:e[0]||(e[0]=c=>r.audioReady=!0),onPlay:e[1]||(e[1]=c=>r.playing=!0),preload:"auto"},null,40,ct),p("div",ut,[H(p("button",{class:"rounded border-solid border-2 border-white px-5",onClick:e[2]||(e[2]=c=>t.$refs.gameAudio.play())}," Start ",512),[[I,!r.playing]]),H(p("h1",null,"Score: "+U(r.score),513),[[I,r.playing]])])])])}const ht=F(K,[["render",dt],["__scopeId","data-v-41db1724"]]);var w=(t=>(t.setBPM="SET_BPM",t.offset="OFFSET",t.trackValue="TRACK_VALUE",t.stop="STOP",t))(w||{}),s=(t=>(t.empty="NONE",t.step="STEP",t.hold="HOLD",t.roll="ROLL",t.holdHead="HOLD_HEAD",t.holdTail="HOLD_TAIL",t.holdTailEnd="HOLD_TAIL_END",t.rollHead="ROLL_HEAD",t.rollTail="ROLL_TAIL",t.rollTailEnd="ROLL_TAIL_END",t.mine="MINE",t))(s||{});async function ft(t){var h;let e=t.webkitRelativePath.split("/");e.pop(),e=e.join("/")+"/";const l=/(\s*)\/\/(.*)/;let a=await t.text();for(;a.match(l)!==null;)a=a.replace(l,"");const i=a.split("#").map(u=>u.split(":")).filter(u=>u.length==2).map(u=>[u[0],u[1].split(";")[0]]),c=mt(i);return{title:d(i,"TITLE"),subtitle:d(i,"SUBTITLE"),genre:d(i,"GENRE"),author:d(i,"CREDIT")||"",artist:d(i,"ARTIST")||"",songUrl:E(e,d(i,"MUSIC")),backgroundUrl:E(e,d(i,"BACKGROUND")),bannerUrl:E(e,d(i,"BANNER")),lyricsUrl:E(e,d(i,"LYRICSPATH")),cdCoverUrl:E(e,d(i,"CDIMAGE")),sampleStartMs:k(i),sampleEndMs:pt(i),sampleLevel:((h=c[0])==null?void 0:h.label)||"",selectable:d(i,"SELECTABLE")!=="NO",difficulties:c}}function d(t,e,l=0){const a=t.filter(r=>r[0]===e)[l];if(a)return a[1]===""?void 0:a[1]}function E(t,e){if(e!==void 0)return t+e}function k(t){return parseFloat(d(t,"SAMPLESTART"))*1e3}function pt(t){const e=k(t),l=parseFloat(d(t,"SAMPLELENGTH"))*1e3;return e+l}function mt(t){const e=t.filter(a=>a[0]==="NOTEDATA").length,l=[];for(let a=0;a<e;a++)l.push({label:d(t,"DIFFICULTY",a),difficultyMeter:parseInt(d(t,"METER",a)),notes:gt(d(t,"NOTES",a),d(t,"BPMS"),d(t,"STOPS")||"",parseFloat(d(t,"OFFSET")))});return l.sort((a,r)=>a.difficultyMeter-r.difficultyMeter)}function gt(t,e,l,a){const r=[];a!==0&&r.push({type:w.offset,value:-a,beat:0}),l.split(",").filter(o=>o.includes("=")).map(o=>o.trim().split("=")).forEach(o=>{r.push({type:w.stop,value:parseFloat(o[1]),beat:parseFloat(o[0])})}),e.split(",").filter(o=>o.includes("=")).map(o=>o.trim().split("=")).forEach(o=>{r.push({type:w.setBPM,value:parseFloat(o[1]),beat:parseFloat(o[0])})});let i=0;const c={left:s.empty,down:s.empty,up:s.empty,right:s.empty};return t.split(",").map(o=>o.trim()).forEach(o=>{const h=o.split(`
`),u=4/h.length;h.forEach(m=>{const n={type:w.trackValue,value:u,beat:i,tracks:{left:A(m[0],c.left),down:A(m[1],c.down),up:A(m[2],c.up),right:A(m[3],c.right)}};r.push(n),c.left=n.tracks.left,c.down=n.tracks.down,c.up=n.tracks.up,c.right=n.tracks.right,i+=u})}),r}function A(t,e){if(t==="0")return e===s.holdHead||e===s.holdTail?s.holdTail:e===s.rollHead||e===s.rollTail?s.rollTail:s.empty;if(t==="1")return s.step;if(t==="2")return s.holdHead;if(t==="3"&&(e===s.holdHead||e===s.holdTail))return s.holdTailEnd;if(t==="3"&&(e===s.rollHead||e===s.rollTail))return s.rollTailEnd;if(t==="4")return s.rollHead;if(t==="M")return s.mine;throw new Error('Encountered unknown SSC note type "'+t+'" with previous input "'+e+'"')}async function vt(t){var h;let e=t.webkitRelativePath.split("/");e.pop(),e=e.join("/")+"/";const l=/(\s*)\/\/(.*)/;let a=await t.text();for(;a.match(l)!==null;)a=a.replace(l,"");const i=a.split("#").map(u=>u.startsWith("NOTES")?[u.substring(0,5),u.substring(6,u.length-1)]:u.split(":")).filter(u=>u.length==2).map(u=>[u[0],u[1].split(";")[0]]),c=_t(i);return{title:g(i,"TITLE"),subtitle:g(i,"SUBTITLE"),genre:g(i,"GENRE"),author:g(i,"CREDIT")||"",artist:g(i,"ARTIST")||"",songUrl:T(e,g(i,"MUSIC")),backgroundUrl:T(e,g(i,"BACKGROUND")),bannerUrl:T(e,g(i,"BANNER")),lyricsUrl:T(e,g(i,"LYRICSPATH")),cdCoverUrl:T(e,g(i,"CDTITLE")),sampleStartMs:B(i),sampleEndMs:wt(i),sampleLevel:((h=c[0])==null?void 0:h.label)||"",selectable:g(i,"SELECTABLE")!=="NO",difficulties:c}}function g(t,e,l=0){const a=t.filter(r=>r[0]===e)[l];if(a)return a[1]===""?void 0:a[1]}function T(t,e){if(e!==void 0)return t+e}function B(t){return parseFloat(g(t,"SAMPLESTART"))*1e3}function wt(t){const e=B(t),l=parseFloat(g(t,"SAMPLELENGTH"))*1e3;return e+l}function _t(t){return t.filter(a=>a[0]==="NOTES").map(a=>a[1]).map(a=>{const r=a.split(":").map(c=>c.trim());return{label:r[2],difficultyMeter:3,notes:Lt(r[5],g(t,"BPMS"),g(t,"STOPS")||"",parseFloat(g(t,"OFFSET")))}}).sort((a,r)=>a.difficultyMeter-r.difficultyMeter)}function Lt(t,e,l,a){const r=[];a!==0&&r.push({type:w.offset,value:a,beat:0}),l.split(",").filter(o=>o.includes("=")).map(o=>o.trim().split("=")).forEach(o=>{r.push({type:w.stop,value:parseFloat(o[1]),beat:parseFloat(o[0])})}),e.split(",").filter(o=>o.includes("=")).map(o=>o.trim().split("=")).forEach(o=>{r.push({type:w.setBPM,value:parseFloat(o[1]),beat:parseFloat(o[0])})});let i=0;const c={left:s.empty,down:s.empty,up:s.empty,right:s.empty};return t.split(",").map(o=>o.trim()).forEach(o=>{const h=o.split(`
`),u=4/h.length;h.forEach(m=>{const n={type:w.trackValue,value:u,beat:i,tracks:{left:S(m[0],c.left),down:S(m[1],c.down),up:S(m[2],c.up),right:S(m[3],c.right)}};r.push(n),c.left=n.tracks.left,c.down=n.tracks.down,c.up=n.tracks.up,c.right=n.tracks.right,i+=u})}),r}function S(t,e){if(t==="0")return e===s.holdHead||e===s.holdTail?s.holdTail:e===s.rollHead||e===s.rollTail?s.rollTail:s.empty;if(t==="1")return s.step;if(t==="2")return s.holdHead;if(t==="3"&&(e===s.holdHead||e===s.holdTail))return s.holdTailEnd;if(t==="3"&&(e===s.rollHead||e===s.rollTail))return s.rollTailEnd;if(t==="4")return s.rollHead;if(t==="M")return s.mine;throw new Error('Encountered unknown SSC note type "'+t+'" with previous input "'+e+'"')}const bt={class:"relative"},Et={class:"fixed top-0 bottom-0 right-0 overflow-y-auto p-2 text-sm text-white",style:{background:"rgba(34, 34, 34, 0.5)"}},Tt=p("label",{for:"chart-picker",class:"rounded border-solid border-2 px-5 cursor-pointer"}," Load Charts ",-1),Rt=p("hr",null,null,-1),yt={class:"font-semibold"},At={class:"flex gap-1"},St=["onClick"],Ot=$({__name:"index",setup(t){const e=C(null),l=C(0),a=C([]);let r=null;async function i(n){a.value=[],r=n.target.files,await c()}async function c(){if(!r)return;const n=[];for(let f=0;f<r.length;f++){const v=await o(r.item(f));v&&n.push(v)}n.sort((f,v)=>f.chart.title<v.chart.title?-1:1),a.value=n}async function o(n){if(n.name.endsWith(".ssc")){const f=await ft(n);return h(f),{chart:f,path:n.webkitRelativePath,format:"ssc"}}if(n.name.endsWith(".sm")){const f=await vt(n);return h(f),{chart:f,path:n.webkitRelativePath,format:"sm"}}return null}function h(n){n.songUrl=URL.createObjectURL(u(n.songUrl)),n.backgroundUrl&&(n.backgroundUrl=URL.createObjectURL(u(n.backgroundUrl))),n.bannerUrl&&(n.bannerUrl=URL.createObjectURL(u(n.bannerUrl))),n.lyricsUrl&&(n.lyricsUrl=URL.createObjectURL(u(n.lyricsUrl))),n.cdCoverUrl&&(n.cdCoverUrl=URL.createObjectURL(u(n.cdCoverUrl)))}function u(n){for(let f=0;f<r.length;f++){const v=r.item(f);if(v.webkitRelativePath===n)return v}return null}function m(n,f){l.value=f,e.value=n.chart}return(n,f)=>{const v=ht;return _(),L("div",bt,[e.value?(_(),P(v,{key:0,class:"fixed top-0 bottom-0 left-0 right-0",chart:e.value,difficulty:l.value},null,8,["chart","difficulty"])):D("",!0),p("div",Et,[Tt,p("input",{id:"chart-picker",type:"file",webkitdirectory:"",directory:"",onChange:i,class:"hidden"},null,32),(_(!0),L(x,null,M(a.value,b=>(_(),L("div",{key:b.path,class:"my-2"},[Rt,p("div",yt,U(b.chart.title)+"."+U(b.format),1),p("div",At,[(_(!0),L(x,null,M(b.chart.difficulties,(O,N)=>(_(),L("span",{class:"text-xs cursor-pointer",key:O.label,onClick:Ut=>m(b,N)},U(O.label),9,St))),128))])]))),128))])])}}});export{Ot as default};
