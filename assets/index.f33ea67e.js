import{_ as N,t as v,v as w,x as f,L as M,M as H,N as I,y as A,d as U,r as S,O as F,P as x,Q as O}from"./entry.08d812d7.js";function $(t){const e=[];for(const l in t){const a=t[l];if(a.type==="TRACK_VALUE"){const r=a.tracks;(r.left==="HOLD_HEAD"||r.left==="ROLL_HEAD")&&e.push({type:r.left,track:"left",beat:a.beat,value:b(t,"left",l)}),(r.down==="HOLD_HEAD"||r.down==="ROLL_HEAD")&&e.push({type:r.down,track:"down",beat:a.beat,value:b(t,"down",l)}),(r.up==="HOLD_HEAD"||r.up==="ROLL_HEAD")&&e.push({type:r.up,track:"up",beat:a.beat,value:b(t,"up",l)}),(r.right==="HOLD_HEAD"||r.right==="ROLL_HEAD")&&e.push({type:r.right,track:"right",beat:a.beat,value:b(t,"right",l)})}}return e}function b(t,e,l){let a=0,r=parseInt(l);for(;;){const i=t[r++];if(i===void 0){console.error("Found unterminated tail");break}if(i.type==="TRACK_VALUE")if(!["ROLL_TAIL_END","HOLD_TAIL_END"].includes(i.tracks[e]))a+=i.value;else break}return a}function P(t,e,l,a,r,i){l.forEach(c=>{const s=50+(c.beat*r-i*r),u=c.value*r;let h=e.hold;switch(c.type==="ROLL_HEAD"&&(h=e.roll),c.track){case"left":t.drawImage(h,50,s+50,100,u);break;case"down":t.drawImage(h,200,s+60,100,u);break;case"up":t.drawImage(h,350,s+40,100,u);break;case"right":t.drawImage(h,500,s+50,100,u);break}})}function V(t,e,l,a,r){l.filter(i=>i.type==="TRACK_VALUE").forEach(i=>{const p=50+(i.beat*a-r*a);G(t,e,i.tracks,p),W(t,e,i.tracks,p)})}function G(t,e,l,a){t.filter="invert(100%)",l.left==="MINE"&&t.drawImage(e.left,50,a,100,100),l.down==="MINE"&&t.drawImage(e.down,200,a,100,100),l.up==="MINE"&&t.drawImage(e.up,350,a,100,100),l.right==="MINE"&&t.drawImage(e.right,500,a,100,100),t.filter="none"}function W(t,e,l,a){T(l.left)&&t.drawImage(e.left,50,a,100,100),T(l.down)&&t.drawImage(e.down,200,a,100,100),T(l.up)&&t.drawImage(e.up,350,a,100,100),T(l.right)&&t.drawImage(e.right,500,a,100,100)}function T(t){return["STEP","ROLL_HEAD","HOLD_HEAD","ROLL_TAIL_END","HOLD_TAIL_END"].includes(t)}const q={props:{chart:{type:Object,required:!0},difficulty:{type:Number,required:!0}},data(){return{canvasWidth:1920,canvasHeight:1e3,canvasContext:null,animationRequest:null,audioReady:!1,playing:!1,bpm:100,currentBeat:0,nextBeat:0,chartIndex:0,lastFrameTime:0,stopUntil:0,tailMeta:[],upLast:!1,downLast:!1,leftLast:!1,rightLast:!1,upStep:!1,downStep:!1,leftStep:!1,rightStep:!1,scrollSpeed:150,marveleousRange:1,excellentRange:5,greatRange:10,goodRange:25,score:0,combo:0}},computed:{icons(){return{up:this.$refs.up,down:this.$refs.down,left:this.$refs.left,right:this.$refs.right,hold:this.$refs.hold,roll:this.$refs.roll}},notes(){return this.chart.difficulties[this.difficulty].notes.sort((t,e)=>t.beat-e.beat)},tails(){return $(this.notes)}},methods:{mainRenderLoop(t){this.animationRequest=requestAnimationFrame(e=>{const l=e-this.lastFrameTime;this.lastFrameTime=e,this.mainRenderLoop(l)}),this.clearCanvas(),this.canvasContext.scale(window.devicePixelRatio,window.devicePixelRatio),this.drawUI(t),this.playing&&(this.incrementBeat(t),this.canvasContext.globalAlpha=1,this.checkInputs(),P(this.canvasContext,this.icons,this.tails,this.tailMeta,this.scrollSpeed,this.currentBeat),V(this.canvasContext,this.icons,this.notes,this.scrollSpeed,this.currentBeat)),this.canvasContext.scale(1/window.devicePixelRatio,1/window.devicePixelRatio)},clearCanvas(){const t=this.$refs.canvas;this.canvasContext===null&&(this.canvasContext=t.getContext("2d")),this.canvasWidth=t.clientWidth*window.devicePixelRatio,this.canvasHeight=t.clientHeight*window.devicePixelRatio,this.canvasContext.clearRect(0,0,this.canvasWidth,this.canvasHeight)},drawUI(t){this.canvasContext.globalAlpha=.7,this.canvasContext.drawImage(this.icons.left,50,50,100,100),this.canvasContext.drawImage(this.icons.down,200,50,100,100),this.canvasContext.drawImage(this.icons.up,350,50,100,100),this.canvasContext.drawImage(this.icons.right,500,50,100,100)},incrementBeat(t){if(this.currentBeat>=this.nextBeat)for(;;){const e=this.notes[this.chartIndex++];if(e===void 0){console.info("End of song"),this.completeLevel();break}if(e.type==="OFFSET"){this.currentBeat=this.currentBeat+e.value,console.info("Adjusting offset");break}else if(e.type==="SET_BPM")this.bpm=e.value,console.info("Adjusting BPM");else if(e.type==="STOP")console.info("STOPing"),this.stopUntil=this.lastFrameTime+e.value*1e3;else if(e.type==="TRACK_VALUE"){this.nextBeat=this.nextBeat+e.value;break}}if(this.stopUntil<=this.lastFrameTime){const l=this.bpm/60/1e3*t;this.currentBeat=this.currentBeat+l}},checkInputs(){},completeLevel(){this.playing=!1,this.$refs.gameAudio.pause(),this.$refs.gameAudio.currentTime=0,this.bpm=100,this.currentBeat=0,this.nextBeat=0,this.chartIndex=0,this.score=0}},watch:{tails(){this.tailMeta=this.tails.map(t=>({active:!0,available:!0}))},chart(){this.completeLevel()},difficulty(){this.completeLevel()}},mounted(){this.mainRenderLoop(0)},beforeDestroy(){this.animationRequest&&cancelAnimationFrame(this.animationRequest)}},K=""+new URL("left.c90f5fe9.svg",import.meta.url).href,j=""+new URL("down.2d1e9473.svg",import.meta.url).href,Y=""+new URL("up.3debce1e.svg",import.meta.url).href,Q=""+new URL("right.d17938a6.svg",import.meta.url).href,z=""+new URL("hold.a53bb1d9.svg",import.meta.url).href,J=""+new URL("roll.2890998c.svg",import.meta.url).href;const X={class:"w-full h-full relative"},Z=["src"],tt={ref:"left",class:"hidden",src:K,loading:"eager"},et={ref:"down",class:"hidden",src:j,loading:"eager"},at={ref:"up",class:"hidden",src:Y,loading:"eager"},rt={ref:"right",class:"hidden",src:Q,loading:"eager"},lt={ref:"hold",class:"hidden",src:z,loading:"eager"},it={ref:"roll",class:"hidden",src:J,mloading:"eager"},st=["width","height"],nt=["src"],ot={class:"w-full h-full relative p-10 font-extrabold text-2xl text-white"};function ct(t,e,l,a,r,i){return v(),w("div",null,[f("div",X,[l.chart.backgroundUrl?(v(),w("img",{key:0,class:"absolute w-full h-full top-0 left-0 right-0 bottom-0 object-cover",src:l.chart.backgroundUrl},null,8,Z)):M("",!0),f("img",tt,null,512),f("img",et,null,512),f("img",at,null,512),f("img",rt,null,512),f("img",lt,null,512),f("img",it,null,512),f("canvas",{class:"track-canvas",ref:"canvas",width:r.canvasWidth,height:r.canvasHeight},null,8,st),f("audio",{ref:"gameAudio",src:l.chart.songUrl,onCanplaythrough:e[0]||(e[0]=c=>r.audioReady=!0),onPlay:e[1]||(e[1]=c=>r.playing=!0),preload:"auto"},null,40,nt),f("div",ot,[H(f("button",{class:"rounded border-solid border-2 border-white px-5",onClick:e[2]||(e[2]=c=>t.$refs.gameAudio.play())}," Start ",512),[[I,!r.playing]]),H(f("h1",null,"Score: "+A(r.score),513),[[I,r.playing]])])])])}const ht=N(q,[["render",ct],["__scopeId","data-v-41db1724"]]);var g=(t=>(t.setBPM="SET_BPM",t.offset="OFFSET",t.trackValue="TRACK_VALUE",t.stop="STOP",t))(g||{}),n=(t=>(t.empty="NONE",t.step="STEP",t.hold="HOLD",t.roll="ROLL",t.holdHead="HOLD_HEAD",t.holdTail="HOLD_TAIL",t.holdTailEnd="HOLD_TAIL_END",t.rollHead="ROLL_HEAD",t.rollTail="ROLL_TAIL",t.rollTailEnd="ROLL_TAIL_END",t.mine="MINE",t))(n||{});async function ut(t){var p;let e=t.webkitRelativePath.split("/");e.pop(),e=e.join("/")+"/";const l=/(\s*)\/\/(.*)/;let a=await t.text();for(;a.match(l)!==null;)a=a.replace(l,"");const i=a.split("#").map(s=>s.split(":")).filter(s=>s.length==2).map(s=>[s[0],s[1].split(";")[0]]),c=ft(i);return{title:d(i,"TITLE"),subtitle:d(i,"SUBTITLE"),genre:d(i,"GENRE"),author:d(i,"CREDIT")||"",artist:d(i,"ARTIST")||"",songUrl:E(e,d(i,"MUSIC")),backgroundUrl:E(e,d(i,"BACKGROUND")),bannerUrl:E(e,d(i,"BANNER")),lyricsUrl:E(e,d(i,"LYRICSPATH")),cdCoverUrl:E(e,d(i,"CDIMAGE")),sampleStartMs:D(i),sampleEndMs:dt(i),sampleLevel:((p=c[0])==null?void 0:p.label)||"",selectable:d(i,"SELECTABLE")!=="NO",difficulties:c}}function d(t,e,l=0){const a=t.filter(r=>r[0]===e)[l];if(a)return a[1]===""?void 0:a[1]}function E(t,e){if(e!==void 0)return t+e}function D(t){return parseFloat(d(t,"SAMPLESTART"))*1e3}function dt(t){const e=D(t),l=parseFloat(d(t,"SAMPLELENGTH"))*1e3;return e+l}function ft(t){const e=t.filter(a=>a[0]==="NOTEDATA").length,l=[];for(let a=0;a<e;a++)l.push({label:d(t,"DIFFICULTY",a),difficultyMeter:parseInt(d(t,"METER",a)),notes:pt(d(t,"NOTES",a),d(t,"BPMS"),d(t,"STOPS")||"",parseFloat(d(t,"OFFSET")))});return l.sort((a,r)=>a.difficultyMeter-r.difficultyMeter)}function pt(t,e,l,a){const r=[];a!==0&&r.push({type:g.offset,value:-a,beat:0}),l.split(",").filter(o=>o.includes("=")).map(o=>o.trim().split("=")).forEach(o=>{r.push({type:g.stop,value:parseFloat(o[1]),beat:parseFloat(o[0])})}),e.split(",").filter(o=>o.includes("=")).map(o=>o.trim().split("=")).forEach(o=>{r.push({type:g.setBPM,value:parseFloat(o[1]),beat:parseFloat(o[0])})});let i=0;const c={left:n.empty,down:n.empty,up:n.empty,right:n.empty};return t.split(",").map(o=>o.trim()).forEach(o=>{const p=o.split(`
`),s=4/p.length;p.forEach(u=>{const h={type:g.trackValue,value:s,beat:i,tracks:{left:y(u[0],c.left),down:y(u[1],c.down),up:y(u[2],c.up),right:y(u[3],c.right)}};r.push(h),c.left=h.tracks.left,c.down=h.tracks.down,c.up=h.tracks.up,c.right=h.tracks.right,i+=s})}),r}function y(t,e){if(t==="0")return e===n.holdHead||e===n.holdTail?n.holdTail:e===n.rollHead||e===n.rollTail?n.rollTail:n.empty;if(t==="1")return n.step;if(t==="2")return n.holdHead;if(t==="3"&&(e===n.holdHead||e===n.holdTail))return n.holdTailEnd;if(t==="3"&&(e===n.rollHead||e===n.rollTail))return n.rollTailEnd;if(t==="4")return n.rollHead;if(t==="M")return n.mine;throw new Error('Encountered unknown SSC note type "'+t+'" with previous input "'+e+'"')}async function mt(t){var p;let e=t.webkitRelativePath.split("/");e.pop(),e=e.join("/")+"/";const l=/(\s*)\/\/(.*)/;let a=await t.text();for(;a.match(l)!==null;)a=a.replace(l,"");const i=a.split("#").map(s=>s.startsWith("NOTES")?[s.substring(0,5),s.substring(6,s.length-1)]:s.split(":")).filter(s=>s.length==2).map(s=>[s[0],s[1].split(";")[0]]),c=vt(i);return{title:m(i,"TITLE"),subtitle:m(i,"SUBTITLE"),genre:m(i,"GENRE"),author:m(i,"CREDIT")||"",artist:m(i,"ARTIST")||"",songUrl:L(e,m(i,"MUSIC")),backgroundUrl:L(e,m(i,"BACKGROUND")),bannerUrl:L(e,m(i,"BANNER")),lyricsUrl:L(e,m(i,"LYRICSPATH")),cdCoverUrl:L(e,m(i,"CDTITLE")),sampleStartMs:B(i),sampleEndMs:gt(i),sampleLevel:((p=c[0])==null?void 0:p.label)||"",selectable:m(i,"SELECTABLE")!=="NO",difficulties:c}}function m(t,e,l=0){const a=t.filter(r=>r[0]===e)[l];if(a)return a[1]===""?void 0:a[1]}function L(t,e){if(e!==void 0)return t+e}function B(t){return parseFloat(m(t,"SAMPLESTART"))*1e3}function gt(t){const e=B(t),l=parseFloat(m(t,"SAMPLELENGTH"))*1e3;return e+l}function vt(t){return t.filter(a=>a[0]==="NOTES").map(a=>a[1]).map(a=>{const r=a.split(":").map(c=>c.trim());return{label:r[2],difficultyMeter:3,notes:wt(r[5],m(t,"BPMS"),m(t,"STOPS")||"",parseFloat(m(t,"OFFSET")))}}).sort((a,r)=>a.difficultyMeter-r.difficultyMeter)}function wt(t,e,l,a){const r=[];a!==0&&r.push({type:g.offset,value:a,beat:0}),l.split(",").filter(o=>o.includes("=")).map(o=>o.trim().split("=")).forEach(o=>{r.push({type:g.stop,value:parseFloat(o[1]),beat:parseFloat(o[0])})}),e.split(",").filter(o=>o.includes("=")).map(o=>o.trim().split("=")).forEach(o=>{r.push({type:g.setBPM,value:parseFloat(o[1]),beat:parseFloat(o[0])})});let i=0;const c={left:n.empty,down:n.empty,up:n.empty,right:n.empty};return t.split(",").map(o=>o.trim()).forEach(o=>{const p=o.split(`
`),s=4/p.length;p.forEach(u=>{const h={type:g.trackValue,value:s,beat:i,tracks:{left:R(u[0],c.left),down:R(u[1],c.down),up:R(u[2],c.up),right:R(u[3],c.right)}};r.push(h),c.left=h.tracks.left,c.down=h.tracks.down,c.up=h.tracks.up,c.right=h.tracks.right,i+=s})}),r}function R(t,e){if(t==="0")return e===n.holdHead||e===n.holdTail?n.holdTail:e===n.rollHead||e===n.rollTail?n.rollTail:n.empty;if(t==="1")return n.step;if(t==="2")return n.holdHead;if(t==="3"&&(e===n.holdHead||e===n.holdTail))return n.holdTailEnd;if(t==="3"&&(e===n.rollHead||e===n.rollTail))return n.rollTailEnd;if(t==="4")return n.rollHead;if(t==="M")return n.mine;throw new Error('Encountered unknown SSC note type "'+t+'" with previous input "'+e+'"')}const _t={class:"relative"},Et={class:"fixed top-0 bottom-0 right-0 overflow-y-auto p-2 text-sm text-white",style:{background:"rgba(34, 34, 34, 0.5)"}},Lt=f("label",{for:"chart-picker",class:"rounded border-solid border-2 px-5 cursor-pointer"}," Load Charts ",-1),bt=f("hr",null,null,-1),Tt={class:"font-semibold"},yt={class:"flex gap-1"},Rt=["onClick"],Ct=U({__name:"index",setup(t){const e=S(null),l=S(0),a=S([]);let r=null;async function i(s){a.value=[],r=s.target.files,await c()}async function c(){if(!r)return;const s=[];for(let u=0;u<r.length;u++){const h=await o(r.item(u));h&&s.push(h)}s.sort((u,h)=>u.chart.title<h.chart.title?-1:1),a.value=s}async function o(s){return s.name.endsWith(".ssc")?{chart:await ut(s),path:s.webkitRelativePath,format:"ssc"}:s.name.endsWith(".sm")?{chart:await mt(s),path:s.webkitRelativePath,format:"sm"}:null}function p(s,u){l.value=u,e.value=s.chart}return(s,u)=>{const h=ht;return v(),w("div",_t,[e.value?(v(),F(h,{key:0,class:"fixed top-0 bottom-0 left-0 right-0",chart:e.value,difficulty:l.value},null,8,["chart","difficulty"])):M("",!0),f("div",Et,[Lt,f("input",{id:"chart-picker",type:"file",webkitdirectory:"",directory:"",onChange:i,class:"hidden"},null,32),(v(!0),w(x,null,O(a.value,_=>(v(),w("div",{key:_.path,class:"my-2"},[bt,f("div",Tt,A(_.chart.title)+"."+A(_.format),1),f("div",yt,[(v(!0),w(x,null,O(_.chart.difficulties,(C,k)=>(v(),w("span",{class:"text-xs cursor-pointer",key:C.label,onClick:At=>p(_,k)},A(C.label),9,Rt))),128))])]))),128))])])}}});export{Ct as default};
