import{_ as F,t as _,v as b,x as p,L as k,M as H,N as I,y as S,d as $,r as U,O as P,P as x,Q as M}from"./entry.551b1388.js";function V(t){const e=[];for(const i in t){const a=t[i];if(a.type==="TRACK_VALUE"){const l=a.tracks;(l.left==="HOLD_HEAD"||l.left==="ROLL_HEAD")&&e.push({type:l.left,track:"left",beat:a.beat,value:y(t,"left",i)}),(l.down==="HOLD_HEAD"||l.down==="ROLL_HEAD")&&e.push({type:l.down,track:"down",beat:a.beat,value:y(t,"down",i)}),(l.up==="HOLD_HEAD"||l.up==="ROLL_HEAD")&&e.push({type:l.up,track:"up",beat:a.beat,value:y(t,"up",i)}),(l.right==="HOLD_HEAD"||l.right==="ROLL_HEAD")&&e.push({type:l.right,track:"right",beat:a.beat,value:y(t,"right",i)})}}return e}function y(t,e,i){let a=0,l=parseInt(i);for(;;){const n=t[l++];if(n===void 0){console.error("Found unterminated tail");break}if(n.type==="TRACK_VALUE")if(!["ROLL_TAIL_END","HOLD_TAIL_END"].includes(n.tracks[e]))a+=n.value;else break}return a}function j(t,e,i,a,l,n){i.forEach(c=>{const d=50+(c.beat*l-n*l),m=c.value*l;let r=e.hold;switch(c.type==="ROLL_HEAD"&&(r=e.roll),c.track){case"left":t.drawImage(r,50,d+50,100,m);break;case"down":t.drawImage(r,200,d+60,100,m);break;case"up":t.drawImage(r,350,d+40,100,m);break;case"right":t.drawImage(r,500,d+50,100,m);break}})}function G(t,e,i,a,l){i.filter(n=>n.type==="TRACK_VALUE").forEach(n=>{const f=50+(n.beat*a-l*a);W(t,e,n.tracks,f),q(t,e,n.tracks,f)})}function W(t,e,i,a){t.filter="invert(100%)",i.left==="MINE"&&t.drawImage(e.left,50,a,100,100),i.down==="MINE"&&t.drawImage(e.down,200,a,100,100),i.up==="MINE"&&t.drawImage(e.up,350,a,100,100),i.right==="MINE"&&t.drawImage(e.right,500,a,100,100),t.filter="none"}function q(t,e,i,a){R(i.left)&&t.drawImage(e.left,50,a,100,100),R(i.down)&&t.drawImage(e.down,200,a,100,100),R(i.up)&&t.drawImage(e.up,350,a,100,100),R(i.right)&&t.drawImage(e.right,500,a,100,100)}function R(t){return["STEP","ROLL_HEAD","HOLD_HEAD","ROLL_TAIL_END","HOLD_TAIL_END"].includes(t)}const K={props:{chart:{type:Object,required:!0},difficulty:{type:Number,required:!0}},data(){return{canvasWidth:1920,canvasHeight:1e3,canvasContext:null,animationRequest:null,audioReady:!1,playing:!1,bpm:100,currentBeat:0,nextBeat:0,chartIndex:0,lastFrameTime:0,stopUntil:0,tailMeta:[],upLast:!1,downLast:!1,leftLast:!1,rightLast:!1,upStep:!1,downStep:!1,leftStep:!1,rightStep:!1,scrollSpeed:150,marveleousRange:1,excellentRange:5,greatRange:10,goodRange:25,score:0,combo:0}},computed:{icons(){return{up:this.$refs.up,down:this.$refs.down,left:this.$refs.left,right:this.$refs.right,hold:this.$refs.hold,roll:this.$refs.roll}},notes(){return this.chart.difficulties[this.difficulty].notes.sort((t,e)=>t.beat-e.beat)},tails(){return V(this.notes)}},methods:{mainRenderLoop(t){this.animationRequest=requestAnimationFrame(e=>{const i=e-this.lastFrameTime;this.lastFrameTime=e,this.mainRenderLoop(i)}),this.clearCanvas(),this.canvasContext.scale(window.devicePixelRatio,window.devicePixelRatio),this.drawUI(t),this.playing&&(this.incrementBeat(t),this.canvasContext.globalAlpha=1,this.checkInputs(),j(this.canvasContext,this.icons,this.tails,this.tailMeta,this.scrollSpeed,this.currentBeat),G(this.canvasContext,this.icons,this.notes,this.scrollSpeed,this.currentBeat)),this.canvasContext.scale(1/window.devicePixelRatio,1/window.devicePixelRatio)},clearCanvas(){const t=this.$refs.canvas;this.canvasContext===null&&(this.canvasContext=t.getContext("2d")),this.canvasWidth=t.clientWidth*window.devicePixelRatio,this.canvasHeight=t.clientHeight*window.devicePixelRatio,this.canvasContext.clearRect(0,0,this.canvasWidth,this.canvasHeight)},drawUI(t){this.canvasContext.globalAlpha=.7,this.canvasContext.drawImage(this.icons.left,50,50,100,100),this.canvasContext.drawImage(this.icons.down,200,50,100,100),this.canvasContext.drawImage(this.icons.up,350,50,100,100),this.canvasContext.drawImage(this.icons.right,500,50,100,100)},incrementBeat(t){if(this.currentBeat>=this.nextBeat)for(;;){const e=this.notes[this.chartIndex++];if(e===void 0){console.info("End of song"),this.completeLevel();break}if(e.type==="OFFSET"){this.currentBeat=this.currentBeat+e.value,console.info("Adjusting offset");break}else if(e.type==="SET_BPM")this.bpm=e.value,console.info("Adjusting BPM");else if(e.type==="STOP")console.info("STOPing"),this.stopUntil=this.lastFrameTime+e.value*1e3;else if(e.type==="TRACK_VALUE"){this.nextBeat=this.nextBeat+e.value;break}}if(this.stopUntil<=this.lastFrameTime){const i=this.bpm/60/1e3*t;this.currentBeat=this.currentBeat+i}},checkInputs(){},completeLevel(){this.playing=!1,this.$refs.gameAudio.pause(),this.$refs.gameAudio.currentTime=0,this.bpm=100,this.currentBeat=0,this.nextBeat=0,this.chartIndex=0,this.score=0}},watch:{tails(){this.tailMeta=this.tails.map(t=>({active:!0,available:!0}))},chart(){this.completeLevel()},difficulty(){this.completeLevel()}},mounted(){this.mainRenderLoop(0)},beforeDestroy(){this.animationRequest&&cancelAnimationFrame(this.animationRequest)}},Y=""+new URL("left.c90f5fe9.svg",import.meta.url).href,Q=""+new URL("down.2d1e9473.svg",import.meta.url).href,z=""+new URL("up.3debce1e.svg",import.meta.url).href,J=""+new URL("right.d17938a6.svg",import.meta.url).href,X=""+new URL("hold.a53bb1d9.svg",import.meta.url).href,Z=""+new URL("roll.2890998c.svg",import.meta.url).href;const tt={class:"w-full h-full relative"},et=["src"],at={ref:"left",class:"hidden",src:Y,loading:"eager"},lt={ref:"down",class:"hidden",src:Q,loading:"eager"},rt={ref:"up",class:"hidden",src:z,loading:"eager"},it={ref:"right",class:"hidden",src:J,loading:"eager"},nt={ref:"hold",class:"hidden",src:X,loading:"eager"},st={ref:"roll",class:"hidden",src:Z,mloading:"eager"},ot=["width","height"],ct=["src"],dt={class:"w-full h-full relative p-10 font-extrabold text-2xl text-white"};function ut(t,e,i,a,l,n){return _(),b("div",null,[p("div",tt,[i.chart.backgroundUrl?(_(),b("img",{key:0,class:"absolute w-full h-full top-0 left-0 right-0 bottom-0 object-cover",src:i.chart.backgroundUrl},null,8,et)):k("",!0),p("img",at,null,512),p("img",lt,null,512),p("img",rt,null,512),p("img",it,null,512),p("img",nt,null,512),p("img",st,null,512),p("canvas",{class:"track-canvas",ref:"canvas",width:l.canvasWidth,height:l.canvasHeight},null,8,ot),p("audio",{ref:"gameAudio",src:i.chart.songUrl,onCanplaythrough:e[0]||(e[0]=c=>l.audioReady=!0),onPlay:e[1]||(e[1]=c=>l.playing=!0),preload:"auto"},null,40,ct),p("div",dt,[H(p("button",{class:"rounded border-solid border-2 border-white px-5",onClick:e[2]||(e[2]=c=>t.$refs.gameAudio.play())}," Start ",512),[[I,!l.playing]]),H(p("h1",null,"Score: "+S(l.score),513),[[I,l.playing]])])])])}const ht=F(K,[["render",ut],["__scopeId","data-v-41db1724"]]);var w=(t=>(t.setBPM="SET_BPM",t.offset="OFFSET",t.trackValue="TRACK_VALUE",t.stop="STOP",t))(w||{}),s=(t=>(t.empty="NONE",t.step="STEP",t.hold="HOLD",t.roll="ROLL",t.holdHead="HOLD_HEAD",t.holdTail="HOLD_TAIL",t.holdTailEnd="HOLD_TAIL_END",t.rollHead="ROLL_HEAD",t.rollTail="ROLL_TAIL",t.rollTailEnd="ROLL_TAIL_END",t.mine="MINE",t))(s||{});async function ft(t){var f;let e=t.webkitRelativePath.split("/");e.pop(),e=e.join("/")+"/";const i=/(\s*)\/\/(.*)/;let a=await t.text();for(;a.match(i)!==null;)a=a.replace(i,"");const n=a.split("#").map(d=>d.split(":")).filter(d=>d.length==2).map(d=>[d[0],d[1].split(";")[0]]),c=mt(n);return{title:h(n,"TITLE"),subtitle:h(n,"SUBTITLE"),genre:h(n,"GENRE"),author:h(n,"CREDIT")||"",artist:h(n,"ARTIST")||"",songUrl:E(e,h(n,"MUSIC")),backgroundUrl:E(e,h(n,"BACKGROUND")),bannerUrl:E(e,h(n,"BANNER")),lyricsUrl:E(e,h(n,"LYRICSPATH")),cdCoverUrl:E(e,h(n,"CDIMAGE")),sampleStartMs:D(n),sampleEndMs:pt(n),sampleLevel:((f=c[0])==null?void 0:f.label)||"",selectable:h(n,"SELECTABLE")!=="NO",difficulties:c}}function h(t,e,i=0){const a=t.filter(l=>l[0]===e)[i];if(a)return a[1]===""?void 0:a[1]}function E(t,e){if(e!==void 0)return t+e}function D(t){return parseFloat(h(t,"SAMPLESTART"))*1e3}function pt(t){const e=D(t),i=parseFloat(h(t,"SAMPLELENGTH"))*1e3;return e+i}function mt(t){const e=t.filter(a=>a[0]==="NOTEDATA").length,i=[];for(let a=0;a<e;a++)i.push({label:h(t,"DIFFICULTY",a),difficultyMeter:parseInt(h(t,"METER",a)),notes:gt(h(t,"NOTES",a),h(t,"BPMS"),h(t,"STOPS")||"",parseFloat(h(t,"OFFSET")))});return i.sort((a,l)=>a.difficultyMeter-l.difficultyMeter)}function gt(t,e,i,a){const l=[];a!==0&&l.push({type:w.offset,value:-a,beat:0}),i.split(",").filter(o=>o.includes("=")).map(o=>o.trim().split("=")).forEach(o=>{l.push({type:w.stop,value:parseFloat(o[1]),beat:parseFloat(o[0])})}),e.split(",").filter(o=>o.includes("=")).map(o=>o.trim().split("=")).forEach(o=>{l.push({type:w.setBPM,value:parseFloat(o[1]),beat:parseFloat(o[0])})});let n=0;const c={left:s.empty,down:s.empty,up:s.empty,right:s.empty};return t.split(",").map(o=>o.trim()).forEach(o=>{const f=o.split(`
`),d=4/f.length;f.forEach(m=>{const r={type:w.trackValue,value:d,beat:n,tracks:{left:C(m[0],c.left),down:C(m[1],c.down),up:C(m[2],c.up),right:C(m[3],c.right)}};l.push(r),c.left=r.tracks.left,c.down=r.tracks.down,c.up=r.tracks.up,c.right=r.tracks.right,n+=d})}),l}function C(t,e){if(t==="0")return e===s.holdHead||e===s.holdTail?s.holdTail:e===s.rollHead||e===s.rollTail?s.rollTail:s.empty;if(t==="1")return s.step;if(t==="2")return s.holdHead;if(t==="3"&&(e===s.holdHead||e===s.holdTail))return s.holdTailEnd;if(t==="3"&&(e===s.rollHead||e===s.rollTail))return s.rollTailEnd;if(t==="4")return s.rollHead;if(t==="M")return s.mine;throw new Error('Encountered unknown SSC note type "'+t+'" with previous input "'+e+'"')}async function vt(t){var f;let e=t.webkitRelativePath.split("/");e.pop(),e=e.join("/")+"/";const i=/(\s*)\/\/(.*)/;let a=await t.text();for(;a.match(i)!==null;)a=a.replace(i,"");const n=a.split("#").map(d=>d.startsWith("NOTES")?[d.substring(0,5),d.substring(6,d.length-1)]:d.split(":")).filter(d=>d.length==2).map(d=>[d[0],d[1].split(";")[0]]),c=_t(n);return{title:g(n,"TITLE"),subtitle:g(n,"SUBTITLE"),genre:g(n,"GENRE"),author:g(n,"CREDIT")||"",artist:g(n,"ARTIST")||"",songUrl:T(e,g(n,"MUSIC")),backgroundUrl:T(e,g(n,"BACKGROUND")),bannerUrl:T(e,g(n,"BANNER")),lyricsUrl:T(e,g(n,"LYRICSPATH")),cdCoverUrl:T(e,g(n,"CDTITLE")),sampleStartMs:B(n),sampleEndMs:wt(n),sampleLevel:((f=c[0])==null?void 0:f.label)||"",selectable:g(n,"SELECTABLE")!=="NO",difficulties:c}}function g(t,e,i=0){const a=t.filter(l=>l[0]===e)[i];if(a)return a[1]===""?void 0:a[1]}function T(t,e){if(e!==void 0)return t+e}function B(t){return parseFloat(g(t,"SAMPLESTART"))*1e3}function wt(t){const e=B(t),i=parseFloat(g(t,"SAMPLELENGTH"))*1e3;return e+i}function _t(t){return t.filter(a=>a[0]==="NOTES").map(a=>a[1]).map(a=>{const l=a.split(":").map(c=>c.trim());return{label:l[2],difficultyMeter:3,notes:bt(l[5],g(t,"BPMS"),g(t,"STOPS")||"",parseFloat(g(t,"OFFSET")))}}).sort((a,l)=>a.difficultyMeter-l.difficultyMeter)}function bt(t,e,i,a){const l=[];a!==0&&l.push({type:w.offset,value:a,beat:0}),i.split(",").filter(o=>o.includes("=")).map(o=>o.trim().split("=")).forEach(o=>{l.push({type:w.stop,value:parseFloat(o[1]),beat:parseFloat(o[0])})}),e.split(",").filter(o=>o.includes("=")).map(o=>o.trim().split("=")).forEach(o=>{l.push({type:w.setBPM,value:parseFloat(o[1]),beat:parseFloat(o[0])})});let n=0;const c={left:s.empty,down:s.empty,up:s.empty,right:s.empty};return t.split(",").map(o=>o.trim()).forEach(o=>{const f=o.split(`
`),d=4/f.length;f.forEach(m=>{const r={type:w.trackValue,value:d,beat:n,tracks:{left:A(m[0],c.left),down:A(m[1],c.down),up:A(m[2],c.up),right:A(m[3],c.right)}};l.push(r),c.left=r.tracks.left,c.down=r.tracks.down,c.up=r.tracks.up,c.right=r.tracks.right,n+=d})}),l}function A(t,e){if(t==="0")return e===s.holdHead||e===s.holdTail?s.holdTail:e===s.rollHead||e===s.rollTail?s.rollTail:s.empty;if(t==="1")return s.step;if(t==="2")return s.holdHead;if(t==="3"&&(e===s.holdHead||e===s.holdTail))return s.holdTailEnd;if(t==="3"&&(e===s.rollHead||e===s.rollTail))return s.rollTailEnd;if(t==="4")return s.rollHead;if(t==="M")return s.mine;throw new Error('Encountered unknown SSC note type "'+t+'" with previous input "'+e+'"')}const Lt={class:"relative"},Et={class:"fixed top-0 bottom-0 right-0 overflow-y-auto p-2 text-sm text-white",style:{background:"rgba(34, 34, 34, 0.5)"}},Tt=p("label",{for:"chart-picker",class:"rounded border-solid border-2 px-5 cursor-pointer"}," Load Charts ",-1),yt=p("hr",null,null,-1),Rt={class:"font-semibold"},Ct={class:"flex gap-1"},At=["onClick"],Ot=$({__name:"index",setup(t){const e=U(null),i=U(0),a=U([]);let l=null;async function n(r){a.value=[],e.value=null,i.value=0,l=r.target.files,await c()}async function c(){if(!l)return;const r=[];for(let u=0;u<l.length;u++){const v=await o(l.item(u));v&&r.push(v)}r.sort((u,v)=>u.chart.title<v.chart.title?-1:1),a.value=r}async function o(r){if(r.name.endsWith(".ssc")){const u=await ft(r);return f(u),{chart:u,path:r.webkitRelativePath,format:"ssc"}}if(r.name.endsWith(".sm")){const u=await vt(r);return f(u),{chart:u,path:r.webkitRelativePath,format:"sm"}}return null}function f(r){try{r.songUrl=window.URL.createObjectURL(d(r.songUrl))}catch{alert("Chart: "+r.title+" failed to load song")}try{r.backgroundUrl&&(r.backgroundUrl=window.URL.createObjectURL(d(r.backgroundUrl)))}catch{alert("Chart: "+r.title+" failed to load background")}try{r.bannerUrl&&(r.bannerUrl=window.URL.createObjectURL(d(r.bannerUrl)))}catch{console.error("Chart: "+r.title+" failed to load banner")}try{r.lyricsUrl&&(r.lyricsUrl=window.URL.createObjectURL(d(r.lyricsUrl)))}catch{console.error("Chart: "+r.title+" failed to load lyrics")}try{r.cdCoverUrl&&(r.cdCoverUrl=window.URL.createObjectURL(d(r.cdCoverUrl)))}catch{console.error("Chart: "+r.title+" failed to load cd cover "+r.cdCoverUrl)}}function d(r){for(let u=0;u<l.length;u++){const v=l.item(u);if(v.webkitRelativePath===r)return v}return null}function m(r,u){i.value=u,e.value=r.chart}return(r,u)=>{const v=ht;return _(),b("div",Lt,[e.value?(_(),P(v,{key:0,class:"fixed top-0 bottom-0 left-0 right-0",chart:e.value,difficulty:i.value},null,8,["chart","difficulty"])):k("",!0),p("div",Et,[Tt,p("input",{id:"chart-picker",type:"file",webkitdirectory:"",directory:"",onChange:n,class:"hidden"},null,32),(_(!0),b(x,null,M(a.value,L=>(_(),b("div",{key:L.path,class:"my-2"},[yt,p("div",Rt,S(L.chart.title)+"."+S(L.format),1),p("div",Ct,[(_(!0),b(x,null,M(L.chart.difficulties,(O,N)=>(_(),b("span",{class:"text-xs cursor-pointer",key:O.label,onClick:St=>m(L,N)},S(O.label),9,At))),128))])]))),128))])])}}});export{Ot as default};
